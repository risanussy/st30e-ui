<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Hasil Test Potensi</title>

  <!-- Bootstrap CSS -->
  <link 
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" 
    rel="stylesheet"
  />

  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- SweetAlert (untuk notifikasi) -->
  <script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }
    .result {
      width: 595px; 
      height: 687px;
      background-image: url('assets/bg-result.png'); /* Ganti dengan path gambar Anda */
      background-size: cover;
      position: relative;
      margin-bottom: 20px;
    }
    .circle-result {
      position: absolute;
      width: 46px;
      height: 46px;
      border-radius: 50%;
      border: 1px solid black;
      display: flex; 
      align-items: center; 
      justify-content: center;
      font-weight: bold;
      background-color: white;
      color: #000;
      font-size: 0.8rem;
    }
    /* Posisi circle sesuai kebutuhan (menyesuaikan bg-result.png) */
    .circle-result-1  { top: 80px;   right: 60px; }
    .circle-result-2  { top: 129px;  right: 60px; }
    .circle-result-3  { top: 192px;  right: 60px; }
    .circle-result-4  { top: 242px;  right: 60px; }
    .circle-result-5  { top: 291px;  right: 60px; }
    .circle-result-6  { top: 340px;  right: 60px; }
    .circle-result-7  { top: 390px;  right: 60px; }
    .circle-result-8  { top: 438px;  right: 60px; }
    .circle-result-9  { top: 510px;  right: 60px; }
    .circle-result-10 { bottom: 82px; right: 60px; }
    .circle-result-11 { bottom: 82px; right: 109px; }
    .circle-result-12 { bottom: 82px; right: 158px; }
    .circle-result-13 { bottom: 82px; right: 207px; }
    .circle-result-14 { bottom: 82px; left: 248px; }
    .circle-result-15 { bottom: 82px; left: 198px; }
    .circle-result-16 { bottom: 82px; left: 149px; }
    .circle-result-17 { bottom: 82px; left: 60px; }
    .circle-result-18 { bottom: 130px; left: 60px; }
    .circle-result-19 { bottom: 180px; left: 60px; }
    .circle-result-20 { bottom: 300px; left: 60px; }
    .circle-result-21 { bottom: 350px; left: 60px; }
    .circle-result-22 { top: 175px;  left: 60px; }
    .circle-result-23 { top: 128px;  left: 60px; }
    .circle-result-24 { top: 80px;   left: 60px; }
    .circle-result-25 { top: 80px;   left: 110px; }
    .circle-result-26 { top: 80px;   left: 178px; }
    .circle-result-27 { top: 80px;   left: 226px; }
    .circle-result-28 { top: 80px;   left: 275px; }
    .circle-result-29 { top: 80px;   left: 324px; }
    .circle-result-30 { top: 80px;   left: 373px; }

    .price {
      color: red;
      font-weight: bold;
    }
    .line-through {
      text-decoration: line-through;
      color: #666;
      margin-right: 5px;
    }
    .btn-pilih-jadwal {
      background-color: #001f5f;
      color: #fff;
      border: none;
      padding: 10px 20px;
    }
    .btn-pilih-jadwal:hover {
      background-color: #003087;
    }
    .modal-header {
      background-color: #001f5f;
      color: #fff;
    }
    .jadwal-title {
      background-color: #001f5f; 
      color: #fff; 
      display: inline-block;
      padding: 8px 16px;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    .btn-bayar {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 8px 16px;
      margin-top: 10px;
      display: inline-block;
      text-decoration: none;
    }
    .btn-bayar:hover {
      background-color: #218838;
      color: #fff;
    }
    .counter-section p {
      margin: 0;
      font-size: 1rem;
      font-weight: bold;
      color: #dc3545;
    }
    .counter-label {
      margin-right: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Bagian Atas -->
  <h3 class="mb-4">Berikut adalah hasil Test Potensi</h3>
  <div class="row">
    <!-- Kolom Kiri (gambar lingkaran-lingkaran) -->
    <div class="col-md-6">
      <div class="result">
        <!-- Contoh circle (static) -->
        <div class="circle-result circle-result-1">CAR</div>
        <div class="circle-result circle-result-2">SER</div>
        <div class="circle-result circle-result-3">DES</div>
        <div class="circle-result circle-result-4">CRE</div>
        <div class="circle-result circle-result-5">SYN</div>
        <div class="circle-result circle-result-6">MAR</div>
        <div class="circle-result circle-result-7">STR</div>
        <div class="circle-result circle-result-8">VIS</div>
        <div class="circle-result circle-result-9">OPE</div>
        <div class="circle-result circle-result-10">DIS</div>
        <div class="circle-result circle-result-11">SAF</div>
        <div class="circle-result circle-result-12">QCA</div>
        <div class="circle-result circle-result-13">PRO</div>
        <div class="circle-result circle-result-14">ADM</div>
        <div class="circle-result circle-result-15">INT</div>
        <div class="circle-result circle-result-16">JOU</div>
        <div class="circle-result circle-result-17">EXP</div>
        <div class="circle-result circle-result-18">RES</div>
        <div class="circle-result circle-result-19">EVA</div>
        <div class="circle-result circle-result-20">TRE</div>
        <div class="circle-result circle-result-21">ANA</div>
        <div class="circle-result circle-result-22">EDU</div>
        <div class="circle-result circle-result-23">MOT</div>
        <div class="circle-result circle-result-24">AMB</div>
        <div class="circle-result circle-result-25">COM</div>
        <div class="circle-result circle-result-26">ARR</div>
        <div class="circle-result circle-result-27">CMD</div>
        <div class="circle-result circle-result-28">MED</div>
        <div class="circle-result circle-result-29">SEL</div>
        <div class="circle-result circle-result-30">SLC</div>
      </div>
    </div>

    <!-- Kolom Kanan (Informasi) -->
    <div class="col-md-6">
      <br><br>
      <p class="fw-bold m-0 p-0">
        <strong></strong> <span id="userName">-</span> /
      </p>
      <p class="fw-bold m-0 p-0">
        <strong></strong> <span id="userEmail">-</span> /
      </p>
      <p class="fw-bold m-0 p-0">
        <strong></strong> <span id="userPhone">-</span>
      </p>

      <p class="mt-3">
        <strong>Potensi Kekuatan :</strong><br>
        <span id="potensiKekuatan">-</span>
      </p>
      <p>
        <strong>Potensi Kelemahan :</strong><br>
        <span id="potensiKelemahan">-</span>
      </p>

      <p>
        Hasil test potensi ini sudah dikirimkan ke alamat email 
        <em><span id="userEmailCopy">-</span></em><br>
        <small>(check SPAM jika tidak ditemukan di INBOX)</small>
      </p>
    </div>
  </div>

  <!-- Divider -->
  <hr class="my-4">

  <h5>DAPATKAN PENJELASAN LEBIH LENGKAP, PILIH OPSI BERIKUT</h5>

  <!-- OPSI 1 -->
  <div class="p-3 mb-3" style="border: 2px solid #001f5f;">
    <h5 class="mb-2" style="background-color: #001f5f; color: #fff; display:inline-block; padding: 5px 10px;">
      OPSI 1
    </h5>
    <span class="price fs-5">Rp. 350,000</span>
    <ol class="mt-2" style="color: #001f5f;">
      <li>
        Informasi Analisa disampaikan lebih lengkap menurut potensi kekuatan dan potensi kelemahan melalui email 
        <br><small>(klik link <a href="doc/pdf.pdf">contoh</a>)</small>
      </li>
      <li>
        Kamu akan terhubung melalui Zoom dengan Ahli kami untuk berdiskusi hasil test potensi
      </li>
    </ol>
    <button 
      class="btn btn-success mb-2"
      id="btnKonsultasi" data-bs-toggle="modal" data-bs-target="#konsultasiModal"
    >
      TENTUKAN JADWAL KONSULTASI KAMU SEKARANG
    </button>
    <br>
    
    <div class="row">
      <div class="col-3">
        <span class="text-danger fw-bold">(Claim Promo Max 3 jam setelah test)</span> <br>
        <!-- Tambahkan id untuk memudahkan update harga -->
        <span id="originalPrice" class="line-through">Rp. 350,000</span> 
        <span id="promoPrice" class="price">Rp. 250,000</span>
      </div>
      <div class="col-6">
        <div class="counter-section">
          <p>
            <span id="testTimeLabel" class="counter-label">Test kamu : Jam 00.00</span><br>
            <span class="counter-label">CLAIM PROMO MAX :</span>
            <span id="claimTimer">03:00:00</span>
          </p>
          <small>(Counter mundur)</small>
        </div>
      </div>
    </div>
  </div>

  <!-- OPSI 2 -->
  <div class="p-3 mb-3" style="border: 2px solid #001f5f;">
    <h5 class="mb-2" style="background-color: #001f5f; color: #fff; display:inline-block; padding: 5px 10px;">
      OPSI 2
    </h5>
    <span class="price fs-5">Rp. 100,000</span>
    <p style="color: #001f5f;">
      Informasi Analisa disampaikan lebih lengkap menurut potensi kekuatan dan potensi kelemahan melalui email <br>
      <small>(klik link ini <a href="doc/pdf.pdf">contoh</a>)</small>
    </p>
    <a href="payment.html?harga=100000" id="byr100" class="btn btn-primary">
      BAYAR SEKARANG
    </a>
  </div>
</div>

<!-- MODAL PILIH JADWAL KONSULTASI -->
<div class="modal fade" id="konsultasiModal" tabindex="-1" aria-labelledby="konsultasiModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="konsultasiModalLabel">
          Pilih Jadwal Konsultasi, Dilakukan secara kolosal 5-10 peserta
        </h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>      
      <div class="modal-body">
        <div class="row mb-4">
          <div class="col-md-6 text-center">
            <div class="jadwal-title">JADWAL 1</div>
            <p>Rabu, 16 April 2025</p>
            <p>14.00 – 15.00 WIB</p>
            <a 
              href="payment.html?jadwal=1&date=2025-04-16&time=14-15&harga=350000"
              class="btn-bayar"
            >
              BAYAR SEKARANG
            </a>
          </div>
          <div class="col-md-6 text-center">
            <div class="jadwal-title">JADWAL 2</div>
            <p>Jumat, 18 April 2025</p>
            <p>19.00 – 20.00 WIB</p>
            <a 
              href="payment.html?jadwal=2&date=2025-04-18&time=19-20&harga=350000"
              class="btn-bayar"
            >
              BAYAR SEKARANG
            </a>
          </div>
        </div>
      </div>      
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          data-bs-dismiss="modal"
        >
          Tutup
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap Bundle -->
<script 
  src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
></script>

<script>
  const urlParams = new URLSearchParams(window.location.search);
  let baseCon = urlParams.get('payment');
  console.log(baseCon);

  if(baseCon == "true"){
    document.querySelector('#byr100').href = "#";
    document.querySelector('#byr100').classList.add("btn-secondary");
    document.querySelector('#byr100').classList.remove("btn-primary");
    document.querySelector('#btnKonsultasi').disabled = true;
    document.querySelector('#btnKonsultasi').classList.add("btn-secondary");
    document.querySelector('#btnKonsultasi').classList.remove("btn-success");
  }

  /* -----------------------------------------------------
     BAGIAN LOGIC UNTUK MENGATUR DATA USER & REPORT KODE
  ----------------------------------------------------- */

  const userId = localStorage.getItem('caldera_user_id');
  const userNameEl = document.getElementById('userName');
  const userEmailEl = document.getElementById('userEmail');
  const userEmailCopyEl = document.getElementById('userEmailCopy');
  const userPhoneEl = document.getElementById('userPhone');
  const potensiKekuatanEl = document.getElementById('potensiKekuatan');
  const potensiKelemahanEl = document.getElementById('potensiKelemahan');

  let redCodes = [];
  let blackCodes = [];

  const codeMapping = {
    "AMB": "AMBASSADOR",
    "ADM": "ADMINISTRATOR",
    "ANA": "ANALYST",
    "ARR": "ARRANGER",
    "CAR": "CARETAKER",
    "CMD": "COMMANDER",
    "COM": "COMMUNICATOR",
    "CRE": "CREATOR",
    "DES": "DESIGNER",
    "DIS": "DISTRIBUTOR",
    "EDU": "EDUCATOR",
    "EVA": "EVALUATOR",
    "EXP": "EXPLORER",
    "INT": "INTERPRETER",
    "JOU": "JOURNALIST",
    "MAR": "MARKETER",
    "MED": "MEDIATOR",
    "MOT": "MOTIVATOR",
    "OPE": "OPERATOR",
    "PRO": "PRODUCER",
    "QCA": "QUALITY CONTROLLER",
    "RES": "RESTORER",
    "SAF": "SAFEKEEPER",
    "SEL": "SELLER",
    "SER": "SERVER",
    "SLC": "SELECTOR",
    "STR": "STRATEGIST",
    "SYN": "SYNTHESIZER",
    "TRE": "TREASURER",
    "VIS": "VISIONER"
  };

  if (!userId) {
    alert("User ID tidak ditemukan. Silakan login kembali!");
  } else {
    axios.get('https://storage-api.online/api-caldera/public/api/user-choices/report/' + userId)
      .then((response) => {
        const data = response.data.data;
        console.log("Report data:", data);

        // Update warna circle & klasifikasi
        const staticCircles = document.querySelectorAll('.circle-result');
        staticCircles.forEach(circle => {
          const code = circle.textContent.trim();
          const item = data.find(obj => obj.code === code);
          if (item) {
            circle.style.backgroundColor = item.color;
            if (['white', 'yellow'].includes(item.color.toLowerCase())) {
              circle.style.color = '#000';
            } else {
              circle.style.color = '#fff';
            }
            if (item.color.toLowerCase() === 'red') {
              redCodes.push(code);
            } else if (item.color.toLowerCase() === 'black') {
              blackCodes.push(code);
            }
          }
        });

        potensiKekuatanEl.textContent = redCodes.length 
          ? redCodes.map(code => codeMapping[code] || code).join(', ')
          : '-';
        potensiKelemahanEl.textContent = blackCodes.length 
          ? blackCodes.map(code => codeMapping[code] || code).join(', ')
          : '-';

        // --- BAGIAN HITUNG MUNDUR DENGAN PENYIMPANAN DI LOCAL STORAGE ---
        if (data.length > 0) {
          const lastItem = data[data.length - 1];
          const createdAt = new Date(lastItem.created_at);
          // Tampilkan waktu test (format: Jam HH.MM)
          const jam = createdAt.getHours().toString().padStart(2, '0');
          const menit = createdAt.getMinutes().toString().padStart(2, '0');
          document.getElementById('testTimeLabel').textContent = `Test kamu : Jam ${jam}.${menit}`;

          // Hitung waktu akhir promo (3 jam setelah createdAt)
          const countdownDuration = 3 * 60 * 60 * 1000; // 3 jam dalam ms
          const endTimeComputed = createdAt.getTime() + countdownDuration;
          let storedEndTime = localStorage.getItem("claimPromoEnd");
          if (!storedEndTime) {
            storedEndTime = endTimeComputed;
            localStorage.setItem("claimPromoEnd", storedEndTime);
          } else {
            storedEndTime = parseInt(storedEndTime);
          }

          // Fungsi update countdown
          function updateCountdown() {
            const now = new Date().getTime();
            let diffMs = storedEndTime - now;
            if (diffMs <= 0) {
              clearInterval(timerInterval);
              document.getElementById('claimTimer').textContent = "WAKTU HABIS";
              // Ubah harga promo menjadi harga normal (350k)
              document.getElementById('originalPrice').style.display = "none";
              document.getElementById('promoPrice').textContent = "Rp. 350,000";
            } else {
              let claimTime = Math.floor(diffMs / 1000);
              let hours = Math.floor(claimTime / 3600);
              let minutes = Math.floor((claimTime % 3600) / 60);
              let seconds = claimTime % 60;
              hours = hours < 10 ? '0' + hours : hours;
              minutes = minutes < 10 ? '0' + minutes : minutes;
              seconds = seconds < 10 ? '0' + seconds : seconds;
              document.getElementById('claimTimer').textContent = hours + ":" + minutes + ":" + seconds;
            }
          }
          const timerInterval = setInterval(updateCountdown, 1000);
          updateCountdown();
        }

        // --- AKHIR BAGIAN HITUNG MUNDUR ---

        // Kirim email (opsional)
        const userId4email = localStorage.getItem('caldera_user_id');
        if (!userId4email) {
          swal("Error", "User ID tidak ditemukan, silakan login kembali!", "error");
          return;
        }
        axios.get(`https://storage-api.online/api-caldera/public/api/user-info/${userId4email}`)
          .then((res) => {
            const user = res.data.user || {};
            const dataEmail = {
              service_id: 'service_0p6ss8i',
              template_id: 'template_ploa5wp',
              user_id: 'p2G9APNe7wseqydyU',
              template_params: {
                'name': user.name,
                'email': user.email,
                'phone': user.phone,
                'kekuatan': potensiKekuatanEl.textContent,
                'kelemahan': potensiKelemahanEl.textContent,
                'g-recaptcha-response': 'dummy_captcha_token'
              }
            };
            // axios.post('https://api.emailjs.com/api/v1.0/email/send', dataEmail)
            //   .then(() => console.log("Email terkirim via EmailJS"))
            //   .catch(err => console.error("Gagal kirim email:", err));
          })
          .catch((error) => {
            console.error(error);
            swal("Error", "Gagal mendapatkan data user.", "error");
          });
      })
      .catch((error) => {
        console.error(error);
        alert("Terjadi kesalahan saat memuat data report.");
      });

    // Ambil data user untuk ditampilkan
    axios.get('https://storage-api.online/api-caldera/public/api/user-info/' + userId)
      .then(res => {
        const user = res.data.user;
        userNameEl.textContent = user.name ?? '-';
        userEmailEl.textContent = user.email ?? '-';
        userEmailCopyEl.textContent = user.email ?? '-';
        userPhoneEl.textContent = user.phone ?? '-';
      })
      .catch(err => {
        console.error(err);
        alert("Gagal memuat data user.");
      });
  }

  // Jika ada tombol simpan jadwal (contoh)
  const btnSimpanJadwal = document.getElementById('btnSimpanJadwal');
  if (btnSimpanJadwal) {
    btnSimpanJadwal.addEventListener('click', () => {
      const dateInput = document.getElementById('dateInput').value;
      const timeSelect = document.getElementById('timeSelect').value;
    
      if (!dateInput) {
        alert("Silakan pilih tanggal konsultasi!");
        return;
      }
    
      const redirectUrl = `payment.html?harga=350000&date=${dateInput}&time=${timeSelect}`;
      window.location.href = redirectUrl;
    });
  }
</script>

</body>
</html>
